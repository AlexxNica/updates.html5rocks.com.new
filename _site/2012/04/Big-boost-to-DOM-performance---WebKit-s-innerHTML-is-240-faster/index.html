<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta property="twitter:account_id" content="1593210261" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="A resource for developers looking to put HTML5 to use today, including information on specific features and when to use them in your apps.">
<meta name="keywords" content="html5,html 5,html5 demos,html5 examples,javascript,css3,notifications,geolocation,web workers,apppcache,file api,filereader,indexeddb,offline,audio,video,drag and drop,chrome,sse,mobile">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-site-verification" content="E1HOIDkksrWY5npenL8FeQhKn4Ujctd75iO2lfufSyA" />
<title>Big boost to DOM performance - WebKit's innerHTML is 240% faster</title>

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="192x192" href="  /assets/HTML5_Badge_192-f9389f6cad587f357d82be791970c8ad.png">
<meta name="theme-color" content="#3372DF">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="HTML5 Rocks">
<link rel="apple-touch-icon-precomposed" href="/assets/HTML5_Badge_192-f9389f6cad587f357d82be791970c8ad.png
">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/assets/HTML5_Badge_144-ddcf1cea1a1204b1733041733d66f76a.png
">
<meta name="msapplication-TileColor" content="#3372DF">

<!-- TODO: consider rel=canonical -->
<link rel="alternate" type="application/rss+xml" title="HTML5 Rocks RSS" href="http://feeds.feedburner.com/html5rocks">
<link rel="publisher" href="https://plus.google.com/+GoogleChromeDevelopers">

  
    
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ChromiumDev">
<meta name="twitter:creator" content="@sw12">

<meta property="og:type" content="article">
<meta property="og:title" content="Big boost to DOM performance - WebKit's innerHTML is 240% faster - HTML5 Rocks">
<meta property="og:url" content="/2012/04/Big-boost-to-DOM-performance---WebKit-s-innerHTML-is-240-faster">
<meta property="og:description" content="">
<meta property="og:image" content="http://www.html5rocks.com/static/images/profiles/dutton.png">
<meta property="og:site_name" content="HTML5 Rocks - A resource for open web HTML5 developers">

<link rel="author" href="https://www.google.com/profiles/104758683354871067458">
  

<link href="//fonts.googleapis.com/css?family=Open+Sans:600,800|Source+Code+Pro" rel="stylesheet">
<link rel="stylesheet" href="/assets/main-8dae1b06ec239bb8b24c3d98cd1ad04b.css">

<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5-els.js"></script>
<![endif]-->

  </head>
  <body>
    <header class="main" id="siteheader">
  <a href="#sitenav" id="navtoggle"></a>
  <nav id="sitenav" class="container">
    <ul>
      <li id="tutorials_menu">
        <a href="http://www.html5rocks.com" class="tutorials">Home</a>
      </li>
      <li id="tutorials_menu">
        <a href="http://www.html5rocks.com/en/tutorials/?page=1" class="tutorials">Tutorials</a>
      </li>
      <li id="updates_menu">
        <a href="http://www.html5rocks.com/en/updates" class="updates">Updates</a>
      </li>
      <li id="contrib_menu">
        <a href="https://github.com/html5rocks/www.html5rocks.com/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
      </li>
      <li id="slides_menu">
        <a href="http://www.html5rocks.com/en/slides" class="slides">Slides</a>
      </li>
      <li id="resources_menu">
        <a href="http://www.html5rocks.com/en/resources" class="resources">Resources</a>
      </li>
    </ul>
  </nav>
</header>

    <div class="body-content">
      <section class="banner">
        <section class="container">
          <a href="/" class="watermark"></a>
          <h1>Big boost to DOM performance - WebKit's innerHTML is 240% faster</h1>
          
        </section>
      </section>
      <article class="content-wrapper article">
<div class="container">
  <section class="byline clearfix">
    <section class="author-images">
      
        
<!-- TODO: change image address.-->

<img src="http://www.html5rocks.com/static/images/profiles/dutton.png"
     alt="Sam Dutton"
     title="Sam Dutton"
     width="60" height="60"
     class="avatar">



      
    </section>
    <section class="meta">
      <div class="authors">
          
    
    <!-- TODO: change link. -->
    <strong>By</strong> <a href="http://www.html5rocks.com/profiles/#dutton">
      Sam Dutton
    </a> 
  

      </div>
      <div class="published">
        <time pubdate=""><strong>Published:</strong> April 11, 2012</time>
      </div>
      <div class="updated">
        <time><strong>Updated:</strong> April 11, 2012</time>
      </div>
      <div class="comments">
        <span><strong>Comments:</strong> <a href="#disqus_thread" class="load-comments" data-disqus-identifier="http://updates.html5rocks.com/2012/04/Big-boost-to-DOM-performance---WebKit-s-innerHTML-is-240-faster">0</a></span>
      </div>
      <div id="notcompatible" class="hidden">
        Your browser may not support the functionality in this article.
      </div>
    </section>
  </section>
  <section class="content">
    <p>We're very happy to see that some common DOM operations have just skyrocketed in speed. The changes were at the WebKit level, boosting performance for both Safari (JavaScriptCore) and Chrome (V8).</p>

<p>Chrome Engineer Kentaro Hara made seven code optimisations within WebKit; below are the results, which show just how much faster JavaScript DOM access has become:</p>

<div id="chart_div" style="height: 350px;"></div>

<h2>DOM performance boosts summary</h2>

<ul>
<li><a title="WebKit bug and tests: div.innerHTML and div.outerHTML" href="https://bugs.webkit.org/show_bug.cgi?id=81214" target="_blank"><code>div.innerHTML</code> and <code>div.outerHTML</code> <b>performance improved by 2.4x</b></a> (V8, JavaScriptCore)

<li><a title="WebKit bug and tests: div.innerText and div.outerText" href="https://bugs.webkit.org/show_bug.cgi?id=81192" target="_blank"><code>div.innerText</code> and <code>div.outerText</code> performance in Chromium/Mac <b>by 4x</b></a> (V8/Mac)

<li><a title="WebKit bug and tests: CSS property accesses" href="https://bugs.webkit.org/show_bug.cgi?id=80250" target="_blank">CSS property accesses improved <b>by 35%</b></a> (JavaScriptCore)

    <li><a title="WebKit bug and tests: div.classList, div.dataset and div.attributes" href="https://bugs.webkit.org/show_bug.cgi?id=80376" target="_blank"><code>div.classList</code>, <code>div.dataset</code> and <code>div.attributes</code> perf improved by <b>up to 10.9x</b></a> (V8)</li>
    <li><a title="WebKit bug and tests: div.firstElementChild, div.lastElementChild, div.previousElementSibling and div.nextElementSibling" href="https://bugs.webkit.org/show_bug.cgi?id=80506" target="_blank"><code>div.firstElementChild</code>, <code>lastElementChild</code>, <code>previousElementSibling</code> and <code>nextElementSibling</code> perf improved <b>by 7.1x</b></a> (V8)</li>
   <li><a title="WebKit bug and tests: V8 DOM attributes" href="https://bugs.webkit.org/show_bug.cgi?id=80685" target="_blank">V8 DOM attributes access improved <b>by 4 ~ 5%</b></a> (V8)</li>




<p>Below, Kentaro Hara gives details on some of the patches he made. The links are to WebKit bugs with test cases, so you can try out the tests for yourself. The changes were made between WebKit r109829 and r111133: Chrome 17 does not include them; Chrome 19 does.</p>

<h3><a title="WebKit bug and tests: div.innerHTML and div.outerHTML" href="https://bugs.webkit.org/show_bug.cgi?id=81214" target="_blank">Improve performance of <code>div.innerHTML</code> and <code>div.outerHTML</code> by 2.4x</a> (V8, JavaScriptCore)</h3>

<p>Previous behavior in WebKit:</p>
<ol>
    <li>Create a string for each tag.</li>
    <li>Append a created string to <code>Vector&lt;string&gt;</code>, parsing the DOM tree.</li>
    <li>After the parsing, allocate a string whose size is the sum of all strings in the <code>Vector&lt;string&gt;</code>.</li>
    <li>Concatenate all strings in <code>Vector&lt;string&gt;</code>, and return it as <code>innerHTML</code>.</li>
</ol>

<p>New behavior in WebKit:</p>
<ol>
    <li>Allocate one string, say S.</li>
    <li>Concatenate a string for each tag to S, incrementally parsing the DOM tree.</li>
    <li>Return S as <code>innerHTML</code>.</li>
</ol>

<p>In a nutshell, instead of creating a lot of strings and then concatenating them, the patch creates one string and then simply append strings incrementally.</p>

<h3><a title="WebKit bug and tests: div.innerText and div.outerText" href="https://bugs.webkit.org/show_bug.cgi?id=81192" target="_blank">Improve performance of <code>div.innerText</code> and <code>div.outerText</code> in Chromium/Mac by 4x</a> (V8/Mac)</h3>

<p>The patch just changed the initial buffer size for creating <code>innerText</code>. Changing the initial buffer size from 2^16 to 2^15 improved Chromium/Mac performance by 4x. This difference depends on the underlying malloc system.</p>

<h3><a title="WebKit bug and tests: CSS property accesses" href="https://bugs.webkit.org/show_bug.cgi?id=80250" target="_blank">Improve performance of CSS property accesses in JavaScriptCore by 35%</a></h3>

<p>(Note: This is a change for Safari, not for Chrome.)</p>

<p>A CSS property string (e.g. <code>.fontWeight</code>, <code>.backgroundColor</code>) is converted to an integer ID in WebKit. This conversion is heavy. The patch caches the conversion results in a map (i.e. a property string =&gt; an integer ID), so that the conversion won't be conducted multiple times.</p>


<h2>How do the tests work?</h2>

<p>They measure the time of property accesses. In case of <code>innerHTML</code> (the performance test in <a title="Link to WebKit bug and tests" href="bugs.webkit.org/show_bug.cgi?id=81214" target="_blank">bugs.webkit.org/show_bug.cgi?id=81214</a>), the test just measures the time to run the following code:</p>


<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span></code></pre></div>


<p>The performance test uses a large body copied from the HTML spec.</p>

<p>Similarly, the CSS property-accesses test measures the time of the following code:</p>


<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">spanStyle</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spanStyle</span><span class="p">.</span><span class="nx">invalidFontWeight</span><span class="p">;</span>
    <span class="nx">spanStyle</span><span class="p">.</span><span class="nx">invalidColor</span><span class="p">;</span>
    <span class="nx">spanStyle</span><span class="p">.</span><span class="nx">invalidBackgroundColor</span><span class="p">;</span>
    <span class="nx">spanStyle</span><span class="p">.</span><span class="nx">invalidDisplay</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>The good news is that Kentaro Hara believes more performance improvements will be possible for other important DOM attributes and methods.</p>

<p>Bring it on!</p>

<p>Kudos to Haraken and the rest of the team.</p>


<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(drawChart);
function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Test');
    data.addColumn('number', 'Chrome 17');
    data.addColumn('number', 'Chrome 19');
    data.addRows([
    ['div.innerHTML', 2060.8, 1037.8],
    ['div.outerHTML', 4120.8, 2928.4],
    ['body.innerHTML', 834.2, 315.8],
    ['body.outerHTML', 861.2, 311.8],
    ['div.classList', 20046, 9500],
    ['div.classList.foo = 123', 20253, 10183],
    ['div.dataset', 24913, 10507],
    ['div.dataset.foo = 123', 64115, 57941],
    ['div.attributes', 25840, 9521]
    ]);

    var options = {
    title: 'Time taken for DOM access tests (ms: shorter is better)',
    vAxis: {title: '',  titleTextStyle: {color: 'green'}}
};

var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
chart.draw(data, options);
}
</script>
</li></li></li></ul>

  </section>
  <section>
    <!-- TODO: Update link. -->
    
      <a href="/tag/performance" class="tag">performance</a>
    
      <a href="/tag/innerHTML" class="tag">innerHTML</a>
    
      <a href="/tag/DOM" class="tag">DOM</a>
    
  </section>
  <div class="pager">
    
    <a href="/2012/04/Round-up-of-Web-Browser-Internals-Resources">&laquo; Round-up of Web Browser Internals Resources</a>
     | 
    <a href="/2012/04/Processing-XHR2-file-uploads-in-PHP">Processing XHR2 file uploads in PHP &raquo;</a>
    
  </div>
</div>
</article>
<section class="disqus pattern-bg-lighter">
  <div id="disqus" class="container">
    <h2>Comments</h2>
    <div id="disqus_thread">
      <a href="#disqus_thread" class="load-comments"
          data-disqus-identifier="http://updates.html5rocks.com/2012/04/Big-boost-to-DOM-performance---WebKit-s-innerHTML-is-240-faster">0</a>
    </div>
  </div>

  <noscript>
    <p class="center">
      <strong>
        <a href="http://disqus.com/?ref_noscript">Please enable JavaScript to view the comments powered by Disqus.</a>
      </strong>
    </p>
  </noscript>

  <script>

    var disqus_shortname = 'html5rocks';
    var disqus_identifier = 'http://updates.html5rocks.com/2012/04/Big-boost-to-DOM-performance---WebKit-s-innerHTML-is-240-faster';
    var disqus_url = 'http://updates.html5rocks.com/2012/04/Big-boost-to-DOM-performance---WebKit-s-innerHTML-is-240-faster';
    var disqus_developer = 0;

    var disqus_config = function () {
      var funky_language_code_mapping = {
        'de': 'de_inf',
        'es': 'es_ES',
        'pt': 'pt_EU',
        'sr': 'sr_CYRL',
        'sv': 'sv_SE',
        'zh': 'zh_HANT'
      };
      this.language = funky_language_code_mapping['en'] ||
                      'en';

      this.callbacks.onReady = [ function () {
                                    try {
                                      ga('send', 'event', 'View comments');
                                    } catch(err){}
                                 } ];
      this.callbacks.onNewComment = [ function (comment) {
                                        try {
                                          ga('send', 'event', 'Commented');
                                        } catch(err){}
                                      } ];
    };

    window.addEventListener('load', function(e) {

      var c = document.createElement('script');
      c.type = 'text/javascript';
      c.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      c.async = true;

      var s = document.getElementsByTagName('script')[0], sp = s.parentNode;
      sp.insertBefore(c, s);

      if (window.location.hash === '#disqus_thread')
        loadComments();

    }, false);

    var disqus_loaded = false;
    function loadComments() {

      if (disqus_loaded)
        return;

      disqus_loaded = true;

      ga('send', 'event', 'Interactions', 'Comments', 'Comments Loaded');

      var s = document.getElementsByTagName('script')[0], sp = s.parentNode;
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;

      var disqusContainer = document.getElementById('disqus');
      disqusContainer.classList.add('active');

      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      sp.insertBefore(dsq, s);
    }
    var loadCommentsButtons = document.querySelectorAll('.load-comments');
    for(var l = 0; l < loadCommentsButtons.length; l++)
      loadCommentsButtons[l].addEventListener('click', loadComments);

  </script>
</section>



    </div>
    <footer>
  <div class="container">
    
    <h1>Next steps</h1>
    <aside class="panel share">
      <h2>Share</h2>
        <a href="https://twitter.com/share?url=http://www.html5rocks.com/tutorials/shapes/getting-started/&amp;text=Getting Started with CSS Shapes&amp;lang=en&amp;via=ChromiumDev&amp;related=ChromiumDev" class="twitter" target="_blank">Twitter</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://www.html5rocks.com/tutorials/shapes/getting-started/" class="facebook" target="_blank">Facebook</a>
        <a href="https://plus.google.com/share?url=http://www.html5rocks.com/tutorials/shapes/getting-started/" class="gplus" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">Google+</a>
    </aside>
    <aside class="panel rss">
      <h2>Subscribe</h2>
      <p>Enjoyed this article? Grab the <a href="/rss">RSS feed</a> and stay up-to-date.</p>
    </aside>
    
    <p class="licensing">
      Except as otherwise <a href="http://code.google.com/policies.html#restrictions">noted</a>, the content of this page is licensed under the <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License</a>, and code samples are licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
    </p>
  </div>
</footer>


    <script>
      (function() {

        var siteHeader = document.getElementById('siteheader');
        var navToggle = document.getElementById('navtoggle');
        var siteNav = document.getElementById('sitenav');

        navToggle.addEventListener('click', function(e) {
          siteNav.classList.toggle('active');
          e.preventDefault();
        });

      })();
    </script>

    <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create','UA-15028909-7','auto');
      ga('create','UA-49880327-4','auto',{'name':'html5rocks'});
      ga('send','pageview');
      ga('html5rocks.send','pageview');
    </script>
  </body>
</html>
