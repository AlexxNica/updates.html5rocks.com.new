<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta property="twitter:account_id" content="1593210261" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="A resource for developers looking to put HTML5 to use today, including information on specific features and when to use them in your apps.">
<meta name="keywords" content="html5,html 5,html5 demos,html5 examples,javascript,css3,notifications,geolocation,web workers,apppcache,file api,filereader,indexeddb,offline,audio,video,drag and drop,chrome,sse,mobile">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>requestAnimationFrame API: now with sub-millisecond precision</title>

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="192x192" href="  /assets/HTML5_Badge_192-f9389f6cad587f357d82be791970c8ad.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="HTML5 Rocks">
<link rel="apple-touch-icon-precomposed" href="/assets/HTML5_Badge_192-f9389f6cad587f357d82be791970c8ad.png
">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/assets/HTML5_Badge_144-ddcf1cea1a1204b1733041733d66f76a.png
">
<meta name="msapplication-TileColor" content="#3372DF">

<!-- TODO: consider rel=canonical -->
<!-- TODO: consider rel=publisher -->
<link rel="alternate" type="application/rss+xml" title="HTML5 Rocks RSS" href="http://feeds.feedburner.com/html5rocks">
<link rel="publisher" href="https://plus.google.com/+GoogleChromeDevelopers">




  




<link href="//fonts.googleapis.com/css?family=Open+Sans:600,800|Source+Code+Pro" rel="stylesheet">
<link rel="stylesheet" href="/assets/main-8dae1b06ec239bb8b24c3d98cd1ad04b.css">

<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5-els.js"></script>
<![endif]-->

  </head>
  <body>
    <header class="main" id="siteheader">
  <a href="#sitenav" id="navtoggle"></a>
  <nav id="sitenav" class="container">
    <ul>
      <li id="tutorials_menu">
        <a href="http://www.html5rocks.com" class="tutorials">Home</a>
      </li>
      <li id="tutorials_menu">
        <a href="http://www.html5rocks.com/en/tutorials/?page=1" class="tutorials">Tutorials</a>
      </li>
      <li id="updates_menu">
        <a href="http://www.html5rocks.com/en/updates" class="updates">Updates</a>
      </li>
      <li id="contrib_menu">
        <a href="https://github.com/html5rocks/www.html5rocks.com/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
      </li>
      <li id="slides_menu">
        <a href="http://www.html5rocks.com/en/slides" class="slides">Slides</a>
      </li>
      <li id="resources_menu">
        <a href="http://www.html5rocks.com/en/resources" class="resources">Resources</a>
      </li>
    </ul>
  </nav>
</header>

    <div class="body-content">
      <section class="banner">
        <section class="container">
          <a href="/en/" class="watermark"></a>
          <h1>requestAnimationFrame API: now with sub-millisecond precision</h1>
          
        </section>
      </section>
      <article class="content-wrapper article">
<div class="container">
  <section class="byline clearfix">
    <section class="author-images">
      
        
<!-- TODO: change image address.-->

<img src="http://www.html5rocks.com/static/images/profiles/paulirish.png"
     alt="Paul Irish"
     title="Paul Irish"
     width="60" height="60"
     class="avatar">



      
    </section>
    <section class="meta">
      <div class="authors">
          
    
    <!-- TODO: change link. -->
    <strong>By</strong> <a href="http://www.html5rocks.com/profiles/#paulirish">
      Paul Irish
    </a> 
  

      </div>
      <div class="published">
        <time pubdate=""><strong>Published:</strong> May 22, 2012</time>
      </div>
      <div class="updated">
        <time><strong>Updated:</strong> May 22, 2012</time>
      </div>
      <div class="comments">
        <span><strong>Comments:</strong> <a href="#disqus_thread" class="load-comments" data-disqus-identifier="http://updates.html5rocks.com/2012/05/requestAnimationFrame-API-now-with-sub-millisecond-precision"></a></span>
      </div>
      <div id="notcompatible" class="hidden">
        Your browser may not support the functionality in this article.
      </div>
    </section>
  </section>
  <section class="content">
    <p>If you’ve been using <code>requestAnimationFrame</code> you’ve enjoyed seeing your paints synchronized to the refresh rate of the screen, resulting in the most high-fidelity animations possible. Plus, you’re saving your users CPU fan noise and battery-power when they switch to another tab.</p>

<p><strong>There is about to be a change to part of the API</strong>, however. The Timestamp that is passed into your callback function is changing from a typical <code>Date.now()</code>-like timestamp to a high-resolution measurement of floating point milliseconds since the page was opened. <strong>If you use this value, you will need to update your code</strong>, based on the explanation below.</p>

<p>Just to be clear, here is what I’m talking about:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// assuming requestAnimationFrame method has been normalized for all vendor prefixes..</span>
<span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">){</span>
	<span class="c1">// the value of timestamp is changing</span>
<span class="p">});</span></code></pre></div>

<p>If you’re using the common <code>requestAnimFrame</code> shim <a href="http://paulirish.com/2011/requestanimationframe-for-smart-animating/">provided here</a>, then you’re not using the timestamp value. You’re off the hook. :)</p>

<h2 id="why">Why</h2>

<p>Why? Well rAF helps you get the ultimate 60 fps that is ideal, and 60 fps translates to 16.7ms per frame. But measuring with integer milliseconds means we have a precision of 1/16 for everything we want to observe and target.</p>

<p><img src="https://docs.google.com/spreadsheet/oimg?key=0ArK1Uipy0SbDdHJXSjQwRW1iYzItRG5TMjRfbnNZWFE&amp;oid=1&amp;zx=a3ikc9ylp9j" /></p>

<p>As you can see above, the blue bar represents the maximum amount of time you have to do all your work before you paint a new frame (at 60fps). You’re probably doing more than 16 things, but with integer milliseconds you only have the ability to schedule and measure in those very chunky increments. That’s not good enough.</p>

<p>The <a href="http://dvcs.w3.org/hg/webperf/raw-file/tip/specs/HighResolutionTime/Overview.html">High Resolution Timer</a> solves this by providing a far more precise figure:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>         <span class="c1">//  1337376068250</span>
<span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>  <span class="c1">//  20303.427000007</span></code></pre></div>

<p>The high resolution timer is currently available in Chrome as <code>window.performance.webkitNow()</code>, and this value is generally equal to the new argument value passed into the rAF callback. Once the spec progresses through standards further, the method will drop the prefix and be available through <code>performance.now()</code>.</p>

<p>You’ll also notice the two above values are many orders of magnitude different. <code>performance.now()</code> is a measurement of floating point milliseconds since that particular page started to load (the <code>performance.navigationStart</code> to be specific).</p>

<h2 id="in-use">In use</h2>

<p>The key issue that crops is animation libraries that use this design pattern:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">MyAnimation</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">duration</span><span class="p">;</span>
   <span class="nx">requestAnimFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tick</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">MyAnimation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;ended&quot;</span><span class="p">);</span>
     <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
    <span class="p">...</span>
  <span class="nx">requestAnimFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tick</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>

<p>An edit to fix this is pretty easy… augment the <code>startTime</code> and <code>now</code> to use <code>window.performance.now()</code>.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span> <span class="o">?</span>
                 <span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">timing</span><span class="p">.</span><span class="nx">navigationStart</span><span class="p">)</span> <span class="o">:</span>
                 <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span></code></pre></div>

<p>This is a fairly naive implementation, it doesn’t use a prefixed <code>now()</code> method and also assumes <code>Date.now()</code> support, which isn’t in IE8.</p>

<h2 id="feature-detection">Feature detection</h2>

<p>If you’re not using the pattern above and just want to identify which sort of callback value you’re getting you can use this technique:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">){</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">timestamp</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="nx">e12</span><span class="p">){</span>
      <span class="c1">// .. high resolution timer</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// integer milliseconds since unix epoch</span>
  <span class="p">}</span>

  <span class="c1">// ...</span></code></pre></div>

<p>Checking <code>if (timestamp &lt; 1e12)</code> is a quick duck test to see how big of a number we’re dealing with. Technically it could false positive but only if a webpage is open continuously for 30 years. But we’re not able to test if it’s a floating point number (rather than floored to an integer). Ask for enough high resolution timers and you’re <a href="http://jsfiddle.net/xYKW6/3/">bound to get integer values</a> at some point.</p>

<hr />

<p>We plan on pushing this change out in Chrome 21, so if you’re already taking advantage of this callback parameter, be sure to update your code!</p>

  </section>
  <section>
    <!-- TODO: Update link. -->
    
      <a href="/tag/nuts_and_bolts" class="tag">nuts and bolts</a>
    
      <a href="/tag/internals" class="tag">internals</a>
    
      <a href="/tag/performance" class="tag">performance</a>
    
  </section>
  <div class="pager">
    
    <a href="/2012/05/Websocket-Frame-Inspection-now-in-Chrome-DevTools">&laquo; Websocket Frame Inspection now in Chrome DevTools</a>
     | 
    <a href="/2012/06/Don-t-Build-Blobs-Construct-Them">Don't Build Blobs, Construct Them &raquo;</a>
    
  </div>
</div>
</article>
<section class="disqus pattern-bg-lighter">
  <div id="disqus" class="container">
    <h2>Comments</h2>
    <div id="disqus_thread">
      <a href="#disqus_thread" class="load-comments"
          data-disqus-identifier="http://updates.html5rocks.com/2012/05/requestAnimationFrame-API-now-with-sub-millisecond-precision">0</a>
    </div>
  </div>

  <noscript>
    <p class="center">
      <strong>
        <a href="http://disqus.com/?ref_noscript">Please enable JavaScript to view the comments powered by Disqus.</a>
      </strong>
    </p>
  </noscript>

  <script>

    var disqus_shortname = 'html5rocks';
    var disqus_identifier = 'http://updates.html5rocks.com/2012/05/requestAnimationFrame-API-now-with-sub-millisecond-precision';
    var disqus_url = 'http://updates.html5rocks.com/2012/05/requestAnimationFrame-API-now-with-sub-millisecond-precision';
    var disqus_developer = 0;

    var disqus_config = function () {
      var funky_language_code_mapping = {
        'de': 'de_inf',
        'es': 'es_ES',
        'pt': 'pt_EU',
        'sr': 'sr_CYRL',
        'sv': 'sv_SE',
        'zh': 'zh_HANT'
      };
      this.language = funky_language_code_mapping['en'] ||
                      'en';

      this.callbacks.onReady = [ function () {
                                    try {
                                      ga('send', 'event', 'View comments');
                                    } catch(err){}
                                 } ];
      this.callbacks.onNewComment = [ function (comment) {
                                        try {
                                          ga('send', 'event', 'Commented');
                                        } catch(err){}
                                      } ];
    };

    window.addEventListener('load', function(e) {

      var c = document.createElement('script');
      c.type = 'text/javascript';
      c.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      c.async = true;

      var s = document.getElementsByTagName('script')[0], sp = s.parentNode;
      sp.insertBefore(c, s);

      if (window.location.hash === '#disqus_thread')
        loadComments();

    }, false);

    var disqus_loaded = false;
    function loadComments() {

      if (disqus_loaded)
        return;

      disqus_loaded = true;

      ga('send', 'event', 'Interactions', 'Comments', 'Comments Loaded');

      var s = document.getElementsByTagName('script')[0], sp = s.parentNode;
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;

      var disqusContainer = document.getElementById('disqus');
      disqusContainer.classList.add('active');

      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      sp.insertBefore(dsq, s);
    }
    var loadCommentsButtons = document.querySelectorAll('.load-comments');
    for(var l = 0; l < loadCommentsButtons.length; l++)
      loadCommentsButtons[l].addEventListener('click', loadComments);

  </script>
</section>



    </div>
    <footer>
  <div class="container">
    
    <h1>Next steps</h1>
    <aside class="panel share">
      <h2>Share</h2>
        <a href="https://twitter.com/share?url=http://www.html5rocks.com/tutorials/shapes/getting-started/&amp;text=Getting Started with CSS Shapes&amp;lang=en&amp;via=ChromiumDev&amp;related=ChromiumDev" class="twitter" target="_blank">Twitter</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://www.html5rocks.com/tutorials/shapes/getting-started/" class="facebook" target="_blank">Facebook</a>
        <a href="https://plus.google.com/share?url=http://www.html5rocks.com/tutorials/shapes/getting-started/" class="gplus" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">Google+</a>
    </aside>
    <aside class="panel rss">
      <h2>Subscribe</h2>
      <p>Enjoyed this article? Grab the <a href="http://feeds.feedburner.com/html5rocks">RSS feed</a> and stay up-to-date.</p>
    </aside>
    
    <p class="licensing">
      Except as otherwise <a href="http://code.google.com/policies.html#restrictions">noted</a>, the content of this page is licensed under the <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License</a>, and code samples are licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>.
    </p>
  </div>
</footer>


    <script>
      (function() {

        var siteHeader = document.getElementById('siteheader');
        var navToggle = document.getElementById('navtoggle');
        var siteNav = document.getElementById('sitenav');

        navToggle.addEventListener('click', function(e) {
          siteNav.classList.toggle('active');
          e.preventDefault();
        });

      })();
    </script>

    <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create','UA-15028909-7','auto');
      ga('create','UA-49880327-4','auto',{'name':'html5rocks'});
      ga('send','pageview');
      ga('html5rocks.send','pageview');
    </script>
  </body>
</html>
